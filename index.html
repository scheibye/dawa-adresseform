<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>Adresse-autocomplete med keyboard dropdown</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      max-width: 500px;
      margin: auto;
    }

    input[type="text"] {
      padding: 0.5rem;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #suggestions {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-top: none;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      margin-top: -1px;
    }

    #suggestions li {
      list-style: none;
      padding: 0.5rem;
      cursor: pointer;
    }

    #suggestions li:hover,
    #suggestions li.active {
      background-color: #f0f0f0;
    }

    label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      margin-top: 1rem;
    }

    button {
      margin-top: 1rem;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #0056b3;
    }

    .relative { position: relative; }
  </style>
</head>
<body>

  <h2>Indtast adresse</h2>

  <div class="relative">
    <input id="addressInput" placeholder="Skriv adresse..." autocomplete="off" />
    <ul id="suggestions"></ul>
  </div>

  <label>
    <input type="checkbox" id="manualOverride" />
    Min adresse findes ikke
  </label>

  <input type="hidden" id="uuid" />

  <button id="submitBtn">Send</button>

  <script>
    const input = document.getElementById('addressInput');
    const suggestions = document.getElementById('suggestions');
    const uuidInput = document.getElementById('uuid');
    const overrideCheckbox = document.getElementById('manualOverride');

    let selectedUUID = null;
    let currentSuggestions = [];
    let activeIndex = -1;

    input.addEventListener('input', async () => {
      const q = input.value.trim();
      selectedUUID = null;
      uuidInput.value = "";
      currentSuggestions = [];
      activeIndex = -1;

      if (q.length < 3) {
        suggestions.innerHTML = '';
        return;
      }

      const res = await fetch(`https://api.dataforsyningen.dk/autocomplete?q=${encodeURIComponent(q)}`);
      const data = await res.json();

      suggestions.innerHTML = '';
      currentSuggestions = data;

      data.forEach((item, index) => {
        const li = document.createElement('li');
        li.textContent = item.tekst;
        li.dataset.index = index;
        li.onclick = () => selectSuggestion(index);
        suggestions.appendChild(li);
      });
    });

    // Handle arrow key navigation
    input.addEventListener('keydown', (e) => {
      const items = suggestions.querySelectorAll('li');

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (activeIndex < currentSuggestions.length - 1) activeIndex++;
        updateActiveItem(items);
      }

      if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (activeIndex > 0) activeIndex--;
        updateActiveItem(items);
      }

      if (e.key === 'Enter' && activeIndex > -1) {
        e.preventDefault();
        selectSuggestion(activeIndex);
      }
    });

    function updateActiveItem(items) {
      items.forEach((item, i) => {
        item.classList.toggle('active', i === activeIndex);
      });
    }

    function selectSuggestion(index) {
      const item = currentSuggestions[index];
      suggestions.innerHTML = '';
      input.value = item.tekst;

      if (item.adresse && item.adresse.id) {
        selectedUUID = item.adresse.id;
        uuidInput.value = selectedUUID;

        // Send UUID to Tally
        window.parent.postMessage({
          type: "tally:prefill",
          data: {
            uuid: selectedUUID
          }
        }, "*");
      } else {
        alert("Du skal vælge en fuld adresse fra listen – ikke kun et vejnavn.");
      }
    }

    // Dismiss suggestions on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#addressInput')) {
        suggestions.innerHTML = '';
      }
    });

    // Send UUID or override to Tally on submit
    document.getElementById('submitBtn').addEventListener('click', function () {
      const overrideChecked = overrideCheckbox.checked;
      const uuid = uuidInput.value;

      if (!overrideChecked && !uuid) {
        alert("Du skal vælge en adresse fra listen – eller markere at din adresse ikke findes.");
      } else {
        const finalValue = overrideChecked ? "MANUAL_OVERRIDE" : uuid;

        window.parent.postMessage({
          type: "tally:prefill",
          data: {
            uuid: finalValue
          }
        }, "*");

        alert("Sendt til Tally ✅\n" + finalValue);
      }
    });
  </script>
</body>
</html>
