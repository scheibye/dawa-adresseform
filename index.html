<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>DAWA Smart Autocomplete</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 500px; margin: auto; }
    input { padding: 0.5rem; width: 100%; border: 1px solid #ccc; border-radius: 4px; }
    #suggestions {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      margin-top: -1px;
      z-index: 10;
    }
    #suggestions li {
      list-style: none;
      padding: 0.5rem;
      cursor: pointer;
    }
    #suggestions li:hover, #suggestions li.active {
      background-color: #f0f0f0;
    }
    label { display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem; }
    button {
      margin-top: 1rem;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    .relative { position: relative; }
  </style>
</head>
<body>

  <h2>Indtast adresse</h2>
  <div class="relative">
    <input id="addressInput" placeholder="Start med at skrive..." autocomplete="off" />
    <ul id="suggestions"></ul>
  </div>

  <label>
    <input type="checkbox" id="manualOverride" />
    Min adresse findes ikke
  </label>

  <input type="hidden" id="uuid" />
  <button id="submitBtn">Send</button>

  <script>
    const input = document.getElementById('addressInput');
    const suggestions = document.getElementById('suggestions');
    const uuidInput = document.getElementById('uuid');
    const overrideCheckbox = document.getElementById('manualOverride');

    let currentSuggestions = [];
    let selectedUUID = null;
    let activeIndex = -1;

    // Load suggestions from DAWA
    async function loadSuggestions(query) {
      const res = await fetch(`https://api.dataforsyningen.dk/autocomplete?q=${encodeURIComponent(query)}`);
      const data = await res.json();
      currentSuggestions = data;
      renderSuggestions(data);
    }

    // Render suggestion dropdown
    function renderSuggestions(data) {
      suggestions.innerHTML = '';
      activeIndex = -1;
      data.forEach((item, index) => {
        const li = document.createElement('li');
        li.textContent = item.tekst;
        li.dataset.index = index;
        li.onclick = () => handleSelection(index);
        suggestions.appendChild(li);
      });
    }

    // When user types
    input.addEventListener('input', () => {
      const q = input.value.trim();
      selectedUUID = null;
      uuidInput.value = "";
      if (q.length >= 2) {
        loadSuggestions(q);
      } else {
        suggestions.innerHTML = '';
      }
    });

    // Keyboard nav
    input.addEventListener('keydown', (e) => {
      const items = suggestions.querySelectorAll('li');
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (activeIndex < items.length - 1) activeIndex++;
        updateActiveItem(items);
      }
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (activeIndex > 0) activeIndex--;
        updateActiveItem(items);
      }
      if (e.key === 'Enter' && activeIndex > -1) {
        e.preventDefault();
        handleSelection(activeIndex);
      }
    });

    function updateActiveItem(items) {
      items.forEach((item, i) => item.classList.toggle('active', i === activeIndex));
    }

    // Handle selection
    function handleSelection(index) {
      const item = currentSuggestions[index];
      suggestions.innerHTML = '';
      input.value = item.tekst;

      if (item.adresse && item.adresse.id) {
        selectedUUID = item.adresse.id;
        uuidInput.value = selectedUUID;
        console.log("âœ… Fuldt valgt adresse:", item.tekst);
        console.log("UUID:", selectedUUID);

        // Send to Tally
        window.parent.postMessage({
          type: "tally:prefill",
          data: { uuid: selectedUUID }
        }, "*");
      } else {
        // Not a full address yet â€“ do a refined search
        console.log("ðŸ” Refining search on:", item.tekst);
        loadSuggestions(item.tekst); // Refined query
      }
    }

    // Click outside = close
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#addressInput')) {
        suggestions.innerHTML = '';
      }
    });

    // Submit button
    document.getElementById('submitBtn').addEventListener('click', () => {
      const override = overrideCheckbox.checked;
      const uuid = uuidInput.value;

      if (!override && !uuid) {
        alert("Du skal vÃ¦lge en adresse â€“ eller markere at den ikke findes.");
      } else {
        const final = override ? "MANUAL_OVERRIDE" : uuid;
        window.parent.postMessage({
          type: "tally:prefill",
          data: { uuid: final }
        }, "*");
        alert("âœ… Sendt til Tally:\n" + final);
      }
    });
  </script>
</body>
</html>
